#!/usr/bin/env bash

load_shelltool() {
  for f in 'dotenv.sh'; do
    fp="$HOME/we-mid/bec-analysis/shelltool/$f"
    [ -e "$fp" ] && echo "Loading $fp" && . "$fp"
  done
  unset f
}

dockertags() {
  local repo=$1
  case "$repo" in
    */*) repo="$repo" ;;
    *)   repo="library/$repo" ;;
  esac
  curl -s "https://hub.docker.com/v2/repositories/$repo/tags/?page_size=100" | \
    jq -r '["Tag", "Size(MB)", "Created"],
           (.results[] | [.name, (.full_size/1048576|floor|tostring)+"MB", .last_updated[0:10]])
           | @tsv' | column -t
}
# dockertags nginx
# dockertags grafana/grafana

# sre
# list disk space taken by sub dirs
# depth defaults to 0
# usage: `dud ~/.pm2/logs`, `dud 2 ~/we-mid/*/*`
is_number() {
  case $1 in
    ''|*[!0-9]*) return 1 ;; # 如果为空，或者包含非数字字符，返回 false (1)
    *) return 0 ;;            # 否则，全是数字，返回 true (0)
  esac
}
dud() {
  if is_number "$1"; then
    local depth="$1"; shift
  else
    local depth=0
  fi
  local dirs=("$@")  # support args like'dir/*'
  [ ${#dirs[@]} -eq 0 ] && dirs=(.)
  (set -x; du -h -d "$depth" "${dirs[@]}")
}

# github raw mirror
gitrawdown() {
    if [ $# -lt 2 ]; then
        echo "缺少参数"
        return 1
    fi
    local url=$(echo $1 | \
        sed 's|github.com/\(.*\)/\(.*\)/blob/\(.*\)|raw.githubusercontent.com/\1/\2/refs/heads/\3|g' | \
        sed 's|raw.githubusercontent.com|raw.gitmirror.com|')
    echo "Downloading... $url"
    echo "=> $2"
    curl -fL $url > $2
}
# ocr
# https://gitee.com/we-mid/go/blob/main/ocr
# go install gitee.com/we-mid/go/ocr/cmd/ocrscan@latest
ocr() {
    (
        # best经常遗漏第一行 不可取
        # export TESSDATA_PREFIX=~/we-mid/go/ocr/tessdata_best
        export TESSDATA_PREFIX=~/we-mid/go/ocr/tessdata_fast
        # ocrscan -l eng,chi_sim ${1:-'-c'}
        # ocrscan -l chi_sim,eng ${1:-'-c'}
        ocrscan -l chi_sim ${1:-'-c'}
    )
}

# background raining
# See also: crx/itsraining
# RainyMood: https://rainymood.com
# Mind the Terms of Use: https://rainymood.com/about.php
raining() {
  mpv --loop=1 ~/Documents/rainymood.com.m4a
}

# ollama
function ask() {
    curl http://localhost:11434/api/chat -d "{
        \"model\": \"${2-qwen2:0.5b}\", \"stream\": false,
        \"messages\": [
            { \"role\": \"user\", \"content\": \"$1\" }
        ]
    }"
}
alias a=ask

# electron-forge packaging
function efpack() {
    PRODUCT_NAME=$(jq -r '.productName' package.json)
    yarn package
    codesign --deep --force --verbose --sign - out/$PRODUCT_NAME-darwin-universal/$PRODUCT_NAME.app
}
function efopen() {
    PRODUCT_NAME=$(jq -r '.productName' package.json)
    open out/Track-darwin-universal/$PRODUCT_NAME.app
}

# lookup an ip
function sip() {
  # ip138不直接支持ipv6
  # 使用[[ 和 =~ 进行模式匹配，检查字符串是否包含冒号
  if [[ $1 =~ : ]]; then
    open "https://www.ipshudi.com/$1.htm"
  else
    open "https://www.ip138.com/iplookup.php?ip=$1"
  fi
}
function ipp() {
  # if [[ -z $1 ]]; then
    if [ $# -lt 1 ]; then
        echo "缺少参数"
        return 1
    fi
    echo "---"
    grep -C 5 $1 ~/we-mid/bec-infra/x/ip2r/patch_config.go
    echo "---"
    grep -C 5 $1 ~/we-mid/bec-infra/svc_apis/ip2r_patch.txt
    echo "---"
    grep -C 5 $1 ~/we-mid/bec-analysis/regionmap/src/data/map.js
    echo "---"
    grep -C 5 $1 ~/we-mid/bec-apps/bec-table-server/api_coo/match.go
    echo "---"
}
function geo() {
    if [ $# -lt 1 ]; then
        echo "缺少参数"
        return 1
    fi
    out_city=$(hgrep $1 ~/Documents/100000_full_city.json 1 60)
    [ -n "$out_city" ] && echo $out_city || hgrep $1 ~/Documents/100000_full.json 1 60
}
function hgrep() {
    if [ $# -lt 2 ]; then
        echo "缺少参数"
        return 1
    fi
    lf="${3:-60}"
    rt="${4:-$lf}"
    awk -v kw="$1" -v lf="$lf" -v rt="$rt" '{
        idx=index($0,kw);
        if (idx>0) {
            start=idx-lf;  # 包括关键词前5个字符
            end=idx+length(kw)+rt;  # 包括关键词后5个字符
            # 确保不会超出文本范围
            start=(start<1)?1:start;
            end=(end>length($0))?length($0):end;
            print substr($0,start,end-start+1);
        }
    }' $2
}

# Mac (requires sudo)
# https://blog.fritx.me/?weekly/220922
psbyport() {
  echo 'lsof:'
  out="$(sudo lsof -i -P -n | grep "$1")"
  echo "$out"
  pid=$(echo "$out" | awk '{ print $2 }')
  echo
  echo "pid: $pid"
  echo
  echo 'ps:'
  ps -ef | grep $pid | grep -v ' grep '
}
pss() {
  ps -ef | grep "$1" | grep -v ' grep '
}

# random password
function rndpwd() {
    local n=$1
    r=$(openssl rand -base64 32)
    if [ -n "$n" ]; then
      r=$(echo $r | cut -c-1-$n)
    fi
    echo $r
}

# git
# function gspp() {
#     not_clean=$(if [ -n "$(git status --porcelain)" ]; then echo true; else echo false; fi)
#     dt=$(date '+%Y-%m-%d_%H:%M:%S')
#     if [ $not_clean = true ] ; then
#         git stash push -u -m "$dt"
#     fi
#     git pull --rebase
#     if [ $not_clean = true ] ; then
#         git stash pop
#     fi
# }
function gspp() {
    local customfn="$1"
    # fix ls behavior when gspp called in other scripts
    # local lswip="$(ls -a .wip-git-stash* 2>/dev/null)"
    local lswip="$(sh -c 'ls -a .wip-git-stash* 2>/dev/null')"
    if [ -n "$lswip" ]; then
      echo "Found $lswip"
      echo 'Please check with `git stash list` and remove .wip-git-stash* before you process gspp'
      return 1
    fi
    local notclean=$(test -n "$(git status --porcelain)" && echo true || echo false)
    local dt="$(date '+%Y-%m-%d_%H:%M:%S')"
    local wipfile=".wip-git-stash-u_$(echo "$dt" | sed 's/:/-/g')"

    function _gspp() {
        echo "...gspp stage 1. stash..."
        if [ $notclean = true ]; then
            local wipctn="$(git status)\n\n---\n\n$(git log | head -n 10)"
            git stash push -u -m "$dt"
            echo "$wipctn" > "$wipfile"
        fi
        if [ -n "$customfn" ]; then
            echo "...gspp stage 2. custom fn..."
            $customfn
        else
            echo "...gspp stage 2. pull..."
            git pull --rebase
        fi
        _finally
    }
    function _finally() {
        echo "...gspp stage 3. pop..."
        if [ $notclean = true ]; then
            git stash pop
            rm "$wipfile"
        fi
        echo "...gspp stage 4. reset..."
        git add -A
        git reset
        echo "...gspp stage 5. completed."
    }
    (
        # 绑定信号并在原函数执行前后管理陷阱
        trap '_finally; exit 130' SIGINT
        trap '_finally; exit 131' SIGQUIT
        trap '_finally; exit 143' SIGTERM
        _gspp
        trap - SIGINT SIGQUIT SIGTERM  # 执行完后恢复默认信号行为
    )
}

# npm rush register
function npm_reg() {
  # ~/d is the directory where i develop
  cd ~/d
  mkd "$1"
  npm init -y
  # version `0.0.0` instead of `1.0.0`
  cat package.json | \
    js -to 'x.version = `0.0.0`, JSON.stringify(x, null, 2)+`\n`'  \
    > package.json
  npm publish
}

# short for imagemin
function imgmin() {
  ll -h $1
  imagemin $1 --out-dir .
  ll -h $1
}

# prepend text to file
# https://unix.stackexchange.com/questions/56975/whats-the-command-to-prepend-a-line-to-a-file
function prepend() {
  local text=$2
  local file=$1
  local tmpfile="$file.prepend.tmp"
  (echo $text; cat $file) > $tmpfile; mv $tmpfile $file
}

export PATH=$PATH:$HOME/bin
# alias k=kanban
alias k=kubectl
alias kc=kubectl
alias mk=minikube

# proxy
function proxyenable() {
  networksetup -setwebproxystate "Wi-Fi" on
  networksetup -setsecurewebproxystate "Wi-Fi" on
  networksetup -setsocksfirewallproxystate "Wi-Fi" on
}
function proxydisable() {
  networksetup -setwebproxystate "Wi-Fi" off
  networksetup -setsecurewebproxystate "Wi-Fi" off
  networksetup -setsocksfirewallproxystate "Wi-Fi" off
}
function proxyon() {
  networksetup -getwebproxy "Wi-Fi" | grep -q 'Enabled: Yes' || echo '[warn] proxy set but not enabled now. Start your proxy first or run `proxyenable`'
  export https_proxy=$MY_HTTP_PROXY http_proxy=$MY_HTTP_PROXY all_proxy=$MY_SOCKS_PROXY
  export HTTPS_PROXY=$MY_HTTP_PROXY HTTP_PROXY=$MY_HTTP_PROXY ALL_PROXY=$MY_SOCKS_PROXY
  # Proxies and VPNs | minikube
  # https://minikube.sigs.k8s.io/docs/handbook/vpn_and_proxy/
  export NO_PROXY=localhost,127.0.0.1,10.96.0.0/12,192.168.59.0/24,192.168.49.0/24,192.168.39.0/24
}
function proxyoff() {
  unset https_proxy http_proxy all_proxy
  unset HTTPS_PROXY HTTP_PROXY ALL_PROXY
}
function proxyget() {
  echo "HTTPS_PROXY: $HTTPS_PROXY"
  echo "HTTP_PROXY: $HTTP_PROXY"
  echo "ALL_PROXY: $ALL_PROXY"
  echo "NO_PROXY: $NO_PROXY"
}
